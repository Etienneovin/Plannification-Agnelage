streamlit
pandas
import streamlit as st
from datetime import timedelta, datetime
import pandas as pd

# Interface et Style
st.set_page_config(page_title="Agnel'Plan Pro", page_icon="ğŸ", layout="centered")

st.title("ğŸ‘ Agnel'Plan")
st.markdown("### L'outil de planification pour Ã©leveurs ovins")
st.write("Entrez vos dates de lutte pour gÃ©nÃ©rer votre calendrier de suivi.")

# Formulaire de saisie
with st.expander("âš™ï¸ Configuration du Lot", expanded=True):
    col1, col2 = st.columns(2)
    with col1:
        nom_lot = st.text_input("Nom du lot", value="Lot Printemps 2026")
        nb_cycles = st.number_input("Nombre de cycles de lutte", min_value=1, max_value=5, value=2, help="1 cycle = 16 jours")
    with col2:
        date_debut = st.date_input("Date de dÃ©but de lutte", datetime.now())
        format_date = "%d/%m/%Y"

# --- CALCULS LOGIQUES ---
duree_lutte = nb_cycles * 16
date_fin_lutte = date_debut + timedelta(days=duree_lutte)
date_echo = date_fin_lutte + timedelta(days=45)
date_mise_bas_debut = date_debut + timedelta(days=147)
date_flushing = date_mise_bas_debut - timedelta(days=20)
date_sevrage = date_mise_bas_debut + timedelta(days=70)
date_vente = date_mise_bas_debut + timedelta(days=90)

# --- AFFICHAGE ---
st.info(f"ğŸ“… **RÃ©capitulatif pour le {nom_lot}**")

planning = [
    {"Ã‰vÃ©nement": "ğŸš€ DÃ©but de lutte", "Date": date_debut, "Note": "Mise en lot avec les bÃ©liers"},
    {"Ã‰vÃ©nement": "ğŸ›‘ Fin de lutte", "Date": date_fin_lutte, "Note": "Retrait des bÃ©liers"},
    {"Ã‰vÃ©nement": "ğŸ©º Diagnostic gestation", "Date": date_echo, "Note": "Ã‰chographie (Fin lutte + 45j)"},
    {"Ã‰vÃ©nement": "ğŸŒ¾ DÃ©but Flushing", "Date": date_flushing, "Note": "Boost alimentaire 20j avant mise bas"},
    {"Ã‰vÃ©nement": "ğŸ£ DÃ©but Mise bas", "Date": date_mise_bas_debut, "Note": "Surveillance accrue (J+147)"},
    {"Ã‰vÃ©nement": "ğŸ¼ Sevrage", "Date": date_sevrage, "Note": "SÃ©paration mÃ¨res/agneaux (J+70)"},
    {"Ã‰vÃ©nement": "ğŸ’° Vente agneaux", "Date": date_vente, "Note": "DÃ©but de la pÃ©riode de vente (J+90)"},
]

df = pd.DataFrame(planning)
df['Date'] = df['Date'].apply(lambda x: x.strftime('%d/%b/%Y'))
st.table(df)

# --- GÃ‰NÃ‰RATION DU FICHIER CALENDRIER ---
def create_ics():
    ics = ["BEGIN:VCALENDAR", "VERSION:2.0", "PRODID:-//AgnelPlan//FR"]
    for item in planning:
        d = datetime.strptime(df.loc[df['Ã‰vÃ©nement'] == item['Ã‰vÃ©nement'], 'Date'].values[0], '%d/%b/%Y')
        d_str = d.strftime("%Y%m%d")
        ics.append("BEGIN:VEVENT")
        ics.append(f"SUMMARY:{nom_lot} - {item['Ã‰vÃ©nement']}")
        ics.append(f"DESCRIPTION:{item['Note']}")
        ics.append(f"DTSTART;VALUE=DATE:{d_str}")
        ics.append(f"DTEND;VALUE=DATE:{d_str}")
        ics.append("END:VEVENT")
    ics.append("END:VCALENDAR")
    return "\n".join(ics)

st.download_button(
    label="ğŸ“² TÃ©lÃ©charger pour mon Agenda (Google/iPhone)",
    data=create_ics(),
    file_name=f"Planning_{nom_lot}.ics",
    mime="text/calendar",
    use_container_width=True
)

st.markdown("---")
st.caption("Outil crÃ©Ã© pour les Ã©leveurs. Partagez ce lien avec vos collÃ¨gues !")
